// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  SALESPERSON
}

enum PlanTier {
  STARTER
  GROWTH
  PROFESSIONAL
  ENTERPRISE
}

enum CommissionStatus {
  PENDING
  CALCULATED
  APPROVED
  PAID
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum CommissionRuleType {
  PERCENTAGE    // % of revenue
  FLAT_AMOUNT   // Fixed amount per sale
  TIERED        // Different rates at different thresholds
}

enum CommissionBasis {
  GROSS_REVENUE  // Full invoice amount (default)
  NET_SALES      // Invoice minus returns/credits
}

enum TransactionType {
  SALE           // Regular sale
  RETURN         // Return/credit
  ADJUSTMENT     // Manual adjustment
}

enum CustomerTier {
  STANDARD       // Default tier
  VIP            // High-value customers
  NEW            // New customers
  ENTERPRISE     // Large enterprise deals
}

enum RuleScope {
  GLOBAL              // Apply to all transactions (default)
  CUSTOMER_TIER       // Apply to specific customer tier
  PRODUCT_CATEGORY    // Apply to specific product category
  TERRITORY           // Apply to specific territory
  CUSTOMER_SPECIFIC   // Apply to specific customer
}

enum RulePriority {
  PROJECT_SPECIFIC    // Highest - 100
  CUSTOMER_SPECIFIC   // 90
  PRODUCT_CATEGORY    // 80
  TERRITORY           // 70
  CUSTOMER_TIER       // 60
  DEFAULT             // Lowest - 50
}

// ============================================
// CORE MODELS
// ============================================

model Organization {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  clerkOrgId      String?  @unique // Clerk organization ID for team invitations
  planTier        PlanTier @default(STARTER)
  requireProjects Boolean  @default(true) // Whether projects are required for sales transactions
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  users                  User[]
  clients                Client[]
  projects               Project[]
  commissionPlans        CommissionPlan[]
  salesTransactions      SalesTransaction[]
  commissionCalculations CommissionCalculation[]
  payouts                Payout[]
  auditLogs              AuditLog[]
  productCategories      ProductCategory[]
  territories            Territory[]

  @@map("organizations")
}

model User {
  id             String   @id @default(cuid())
  clerkId        String   @unique
  email          String
  firstName      String?
  lastName       String?
  role           UserRole @default(SALESPERSON)
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  auditLogs      AuditLog[]

  // Notification preferences
  emailNotifications Boolean  @default(true)
  salesAlerts        Boolean  @default(true)
  commissionAlerts   Boolean  @default(true)
  weeklyReports      Boolean  @default(false)

  organization           Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesTransactions      SalesTransaction[]
  commissionCalculations CommissionCalculation[]
  payouts                Payout[]

  @@index([organizationId])
  @@index([clerkId])
  @@map("users")
}

model Client {
  id             String        @id @default(cuid())
  name           String
  email          String?
  phone          String?
  address        String?
  notes          String?
  tier           CustomerTier  @default(STANDARD)
  territoryId    String?
  organizationId String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  territory         Territory?         @relation(fields: [territoryId], references: [id], onDelete: SetNull)
  projects          Project[]
  salesTransactions SalesTransaction[]
  commissionRules   CommissionRule[]

  @@index([organizationId])
  @@index([territoryId])
  @@index([tier])
  @@map("clients")
}

model Project {
  id             String   @id @default(cuid())
  name           String
  description    String?
  clientId       String
  organizationId String
  startDate      DateTime?
  endDate        DateTime?
  status         String   @default("active") // active, completed, cancelled
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization      Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client            Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  commissionPlans   CommissionPlan[]
  salesTransactions SalesTransaction[]

  @@index([organizationId])
  @@index([clientId])
  @@map("projects")
}

model ProductCategory {
  id             String   @id @default(cuid())
  name           String
  description    String?
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesTransactions SalesTransaction[]
  commissionRules   CommissionRule[]

  @@index([organizationId])
  @@map("product_categories")
}

model Territory {
  id             String   @id @default(cuid())
  name           String
  description    String?
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  clients         Client[]
  commissionRules CommissionRule[]

  @@index([organizationId])
  @@map("territories")
}

// ============================================
// COMMISSION PLANNING MODELS
// ============================================

model CommissionPlan {
  id              String           @id @default(cuid())
  name            String
  description     String?
  projectId       String?
  commissionBasis CommissionBasis  @default(GROSS_REVENUE)
  organizationId  String
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  organization           Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project                Project?                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  rules                  CommissionRule[]
  commissionCalculations CommissionCalculation[]

  @@index([organizationId])
  @@index([projectId])
  @@index([commissionBasis])
  @@map("commission_plans")
}

model CommissionRule {
  id               String              @id @default(cuid())
  commissionPlanId String
  ruleType         CommissionRuleType

  // Existing fields
  percentage       Float?              // For PERCENTAGE type
  flatAmount       Float?              // For FLAT_AMOUNT type
  tierThreshold    Float?              // For TIERED type - revenue threshold
  tierPercentage   Float?              // For TIERED type - rate above threshold
  minAmount        Float?              // Minimum commission
  maxAmount        Float?              // Maximum commission (cap)
  description      String?

  // NEW: Scoping fields
  scope            RuleScope           @default(GLOBAL)
  priority         RulePriority        @default(DEFAULT)

  // NEW: Applicability filters (nullable for backward compatibility)
  customerTier     CustomerTier?
  productCategoryId String?
  territoryId      String?
  clientId         String?             // For customer-specific rules

  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  commissionPlan   CommissionPlan      @relation(fields: [commissionPlanId], references: [id], onDelete: Cascade)
  productCategory  ProductCategory?    @relation(fields: [productCategoryId], references: [id], onDelete: SetNull)
  territory        Territory?          @relation(fields: [territoryId], references: [id], onDelete: SetNull)
  client           Client?             @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([commissionPlanId])
  @@index([scope])
  @@index([priority])
  @@index([productCategoryId])
  @@index([territoryId])
  @@index([clientId])
  @@index([customerTier])
  @@map("commission_rules")
}

// ============================================
// TRANSACTION & CALCULATION MODELS
// ============================================

model SalesTransaction {
  id                  String           @id @default(cuid())
  amount              Float
  transactionType     TransactionType  @default(SALE)
  parentTransactionId String?
  projectId           String?          // Optional - depends on organization.requireProjects setting
  clientId            String?          // Direct client reference (for when no project is assigned)
  userId              String           // Salesperson who made the sale
  productCategoryId   String?
  organizationId      String
  transactionDate     DateTime         @default(now())
  description         String?
  invoiceNumber       String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  organization           Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project                Project?                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  client                 Client?                 @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user                   User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productCategory        ProductCategory?        @relation(fields: [productCategoryId], references: [id], onDelete: SetNull)
  parentTransaction      SalesTransaction?       @relation("Returns", fields: [parentTransactionId], references: [id])
  returns                SalesTransaction[]      @relation("Returns")
  commissionCalculations CommissionCalculation[]

  @@index([organizationId])
  @@index([projectId])
  @@index([clientId])
  @@index([userId])
  @@index([productCategoryId])
  @@index([transactionType])
  @@index([transactionDate])
  @@map("sales_transactions")
}

model CommissionCalculation {
  id                 String           @id @default(cuid())
  salesTransactionId String
  commissionPlanId   String
  userId             String           // Salesperson earning the commission
  organizationId     String
  amount             Float            // Calculated commission amount
  status             CommissionStatus @default(PENDING)
  metadata           Json?            // NEW: Store calculation details (applied rules, basis, context)
  calculatedAt       DateTime         @default(now())
  approvedAt         DateTime?        // When the commission was approved
  paidAt             DateTime?        // When the commission was paid
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesTransaction SalesTransaction @relation(fields: [salesTransactionId], references: [id], onDelete: Cascade)
  commissionPlan   CommissionPlan   @relation(fields: [commissionPlanId], references: [id], onDelete: Cascade)
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  payout           Payout?          @relation(fields: [payoutId], references: [id])
  payoutId         String?

  @@index([organizationId])
  @@index([salesTransactionId])
  @@index([userId])
  @@index([status])
  @@map("commission_calculations")
}

model Payout {
  id             String        @id @default(cuid())
  userId         String        // Salesperson receiving payout
  organizationId String
  amount         Float
  status         PayoutStatus  @default(PENDING)
  paymentMethod  String?
  paymentDate    DateTime?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  commissions  CommissionCalculation[]

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@map("payouts")
}


model AuditLog {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  
  // Who performed the action
  userId         String?
  userName       String?  // Cached for display
  userEmail      String?  // Cached for display
  
  // What action was performed
  action         String   // e.g. "commission_approved", "commission_paid", "bulk_payout"
  entityType     String   // e.g. "commission", "sale", "plan"
  entityId       String?  // ID of the entity affected
  
  // Details
  description    String   // Human-readable description
  metadata       Json?    // Additional structured data
  
  // Context
  organizationId String
  ipAddress      String?
  userAgent      String?
  
  // Relations
  user           User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
}


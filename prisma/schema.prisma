// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  SALESPERSON
}

enum PlanTier {
  STARTER
  GROWTH
  PROFESSIONAL
  ENTERPRISE
}

enum CommissionStatus {
  PENDING
  CALCULATED
  APPROVED
  PAID
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum CommissionRuleType {
  PERCENTAGE    // % of revenue
  FLAT_AMOUNT   // Fixed amount per sale
  TIERED        // Different rates at different thresholds
}

// ============================================
// CORE MODELS
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  planTier  PlanTier @default(STARTER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users                  User[]
  clients                Client[]
  projects               Project[]
  commissionPlans        CommissionPlan[]
  salesTransactions      SalesTransaction[]
  commissionCalculations CommissionCalculation[]
  payouts                Payout[]

  @@map("organizations")
}

model User {
  id             String   @id @default(cuid())
  clerkId        String   @unique
  email          String
  firstName      String?
  lastName       String?
  role           UserRole @default(SALESPERSON)
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization           Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesTransactions      SalesTransaction[]
  commissionCalculations CommissionCalculation[]
  payouts                Payout[]

  @@index([organizationId])
  @@index([clerkId])
  @@map("users")
}

model Client {
  id             String   @id @default(cuid())
  name           String
  email          String?
  phone          String?
  address        String?
  notes          String?
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects     Project[]

  @@index([organizationId])
  @@map("clients")
}

model Project {
  id             String   @id @default(cuid())
  name           String
  description    String?
  clientId       String
  organizationId String
  startDate      DateTime?
  endDate        DateTime?
  status         String   @default("active") // active, completed, cancelled
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization      Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client            Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  commissionPlans   CommissionPlan[]
  salesTransactions SalesTransaction[]

  @@index([organizationId])
  @@index([clientId])
  @@map("projects")
}

// ============================================
// COMMISSION PLANNING MODELS
// ============================================

model CommissionPlan {
  id             String   @id @default(cuid())
  name           String
  description    String?
  projectId      String?
  organizationId String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization           Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project                Project?                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  rules                  CommissionRule[]
  commissionCalculations CommissionCalculation[]

  @@index([organizationId])
  @@index([projectId])
  @@map("commission_plans")
}

model CommissionRule {
  id               String              @id @default(cuid())
  commissionPlanId String
  ruleType         CommissionRuleType
  percentage       Float?              // For PERCENTAGE type
  flatAmount       Float?              // For FLAT_AMOUNT type
  tierThreshold    Float?              // For TIERED type - revenue threshold
  tierPercentage   Float?              // For TIERED type - rate above threshold
  minAmount        Float?              // Minimum commission
  maxAmount        Float?              // Maximum commission (cap)
  description      String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  commissionPlan CommissionPlan @relation(fields: [commissionPlanId], references: [id], onDelete: Cascade)

  @@index([commissionPlanId])
  @@map("commission_rules")
}

// ============================================
// TRANSACTION & CALCULATION MODELS
// ============================================

model SalesTransaction {
  id             String    @id @default(cuid())
  amount         Float
  projectId      String
  userId         String    // Salesperson who made the sale
  organizationId String
  transactionDate DateTime @default(now())
  description    String?
  invoiceNumber  String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization           Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project                Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user                   User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  commissionCalculations CommissionCalculation[]

  @@index([organizationId])
  @@index([projectId])
  @@index([userId])
  @@index([transactionDate])
  @@map("sales_transactions")
}

model CommissionCalculation {
  id                 String           @id @default(cuid())
  salesTransactionId String
  commissionPlanId   String
  userId             String           // Salesperson earning the commission
  organizationId     String
  amount             Float            // Calculated commission amount
  status             CommissionStatus @default(PENDING)
  calculatedAt       DateTime         @default(now())
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesTransaction SalesTransaction @relation(fields: [salesTransactionId], references: [id], onDelete: Cascade)
  commissionPlan   CommissionPlan   @relation(fields: [commissionPlanId], references: [id], onDelete: Cascade)
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  payout           Payout?          @relation(fields: [payoutId], references: [id])
  payoutId         String?

  @@index([organizationId])
  @@index([salesTransactionId])
  @@index([userId])
  @@index([status])
  @@map("commission_calculations")
}

model Payout {
  id             String        @id @default(cuid())
  userId         String        // Salesperson receiving payout
  organizationId String
  amount         Float
  status         PayoutStatus  @default(PENDING)
  paymentMethod  String?
  paymentDate    DateTime?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  commissions  CommissionCalculation[]

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@map("payouts")
}

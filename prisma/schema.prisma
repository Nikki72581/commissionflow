generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AuditLog {
  id             String        @id
  createdAt      DateTime      @default(now())
  userId         String?
  userName       String?
  userEmail      String?
  action         String
  entityType     String
  entityId       String?
  description    String
  metadata       Json?
  organizationId String
  ipAddress      String?
  userAgent      String?
  organizations  organizations @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users          users?        @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([organizationId])
  @@index([userId])
}

model clients {
  id                 String               @id
  name               String
  email              String?
  phone              String?
  address            String?
  notes              String?
  organizationId     String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  territoryId        String?
  tier               CustomerTier         @default(STANDARD)
  organizations      organizations        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  territories        territories?         @relation(fields: [territoryId], references: [id])
  commission_rules   commission_rules[]
  projects           projects[]
  sales_transactions sales_transactions[]

  @@index([organizationId])
  @@index([territoryId])
  @@index([tier])
}

model commission_calculations {
  id                 String             @id
  salesTransactionId String
  commissionPlanId   String
  userId             String
  organizationId     String
  amount             Float
  status             CommissionStatus   @default(PENDING)
  calculatedAt       DateTime           @default(now())
  approvedAt         DateTime?
  paidAt             DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime
  payoutId           String?
  metadata           Json?
  commission_plans   commission_plans   @relation(fields: [commissionPlanId], references: [id], onDelete: Cascade)
  organizations      organizations      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payouts            payouts?           @relation(fields: [payoutId], references: [id])
  sales_transactions sales_transactions @relation(fields: [salesTransactionId], references: [id], onDelete: Cascade)
  users              users              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([salesTransactionId])
  @@index([status])
  @@index([userId])
}

model commission_plans {
  id                      String                    @id
  name                    String
  description             String?
  projectId               String?
  organizationId          String
  isActive                Boolean                   @default(true)
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  commissionBasis         CommissionBasis           @default(GROSS_REVENUE)
  commission_calculations commission_calculations[]
  organizations           organizations             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects                projects?                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  commission_rules        commission_rules[]

  @@index([commissionBasis])
  @@index([organizationId])
  @@index([projectId])
}

model commission_rules {
  id                 String              @id
  commissionPlanId   String
  ruleType           CommissionRuleType
  percentage         Float?
  flatAmount         Float?
  tierThreshold      Float?
  tierPercentage     Float?
  minAmount          Float?
  maxAmount          Float?
  description        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime
  clientId           String?
  customerTier       CustomerTier?
  priority           RulePriority        @default(DEFAULT)
  productCategoryId  String?
  scope              RuleScope           @default(GLOBAL)
  territoryId        String?
  clients            clients?            @relation(fields: [clientId], references: [id])
  commission_plans   commission_plans    @relation(fields: [commissionPlanId], references: [id], onDelete: Cascade)
  product_categories product_categories? @relation(fields: [productCategoryId], references: [id])
  territories        territories?        @relation(fields: [territoryId], references: [id])

  @@index([clientId])
  @@index([commissionPlanId])
  @@index([customerTier])
  @@index([priority])
  @@index([productCategoryId])
  @@index([scope])
  @@index([territoryId])
}

model organizations {
  id                      String                    @id
  name                    String
  slug                    String                    @unique
  planTier                PlanTier                  @default(STARTER)
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  clerkOrgId              String?                   @unique
  requireProjects         Boolean                   @default(true)
  AuditLog                AuditLog[]
  clients                 clients[]
  commission_calculations commission_calculations[]
  commission_plans        commission_plans[]
  payouts                 payouts[]
  product_categories      product_categories[]
  projects                projects[]
  sales_transactions      sales_transactions[]
  territories             territories[]
  users                   users[]
}

model payouts {
  id                      String                    @id
  userId                  String
  organizationId          String
  amount                  Float
  status                  PayoutStatus              @default(PENDING)
  paymentMethod           String?
  paymentDate             DateTime?
  notes                   String?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  commission_calculations commission_calculations[]
  organizations           organizations             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users                   users                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@index([userId])
}

model product_categories {
  id                 String               @id
  name               String
  description        String?
  organizationId     String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  commission_rules   commission_rules[]
  organizations      organizations        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sales_transactions sales_transactions[]

  @@index([organizationId])
}

model projects {
  id                 String               @id
  name               String
  description        String?
  clientId           String
  organizationId     String
  startDate          DateTime?
  endDate            DateTime?
  status             String               @default("active")
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  commission_plans   commission_plans[]
  clients            clients              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  organizations      organizations        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sales_transactions sales_transactions[]

  @@index([clientId])
  @@index([organizationId])
}

model sales_transactions {
  id                       String                    @id
  amount                   Float
  projectId                String?
  userId                   String
  organizationId           String
  transactionDate          DateTime                  @default(now())
  description              String?
  invoiceNumber            String?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime
  parentTransactionId      String?
  productCategoryId        String?
  transactionType          TransactionType           @default(SALE)
  clientId                 String?
  commission_calculations  commission_calculations[]
  clients                  clients?                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  organizations            organizations             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sales_transactions       sales_transactions?       @relation("sales_transactionsTosales_transactions", fields: [parentTransactionId], references: [id])
  other_sales_transactions sales_transactions[]      @relation("sales_transactionsTosales_transactions")
  product_categories       product_categories?       @relation(fields: [productCategoryId], references: [id])
  projects                 projects?                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  users                    users                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([organizationId])
  @@index([productCategoryId])
  @@index([projectId])
  @@index([transactionDate])
  @@index([transactionType])
  @@index([userId])
}

model territories {
  id               String             @id
  name             String
  description      String?
  organizationId   String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  clients          clients[]
  commission_rules commission_rules[]
  organizations    organizations      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

model users {
  id                      String                    @id
  clerkId                 String                    @unique
  email                   String
  firstName               String?
  lastName                String?
  role                    UserRole                  @default(SALESPERSON)
  organizationId          String
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  commissionAlerts        Boolean                   @default(true)
  emailNotifications      Boolean                   @default(true)
  salesAlerts             Boolean                   @default(true)
  weeklyReports           Boolean                   @default(false)
  themePreference         String                    @default("system")
  AuditLog                AuditLog[]
  commission_calculations commission_calculations[]
  payouts                 payouts[]
  sales_transactions      sales_transactions[]
  organizations           organizations             @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([clerkId])
  @@index([organizationId])
}

enum CommissionBasis {
  GROSS_REVENUE
  NET_SALES
}

enum CommissionRuleType {
  PERCENTAGE
  FLAT_AMOUNT
  TIERED
}

enum CommissionStatus {
  PENDING
  CALCULATED
  APPROVED
  PAID
}

enum CustomerTier {
  STANDARD
  VIP
  NEW
  ENTERPRISE
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PlanTier {
  STARTER
  GROWTH
  PROFESSIONAL
  ENTERPRISE
}

enum RulePriority {
  PROJECT_SPECIFIC
  CUSTOMER_SPECIFIC
  PRODUCT_CATEGORY
  TERRITORY
  CUSTOMER_TIER
  DEFAULT
}

enum RuleScope {
  GLOBAL
  CUSTOMER_TIER
  PRODUCT_CATEGORY
  TERRITORY
  CUSTOMER_SPECIFIC
}

enum TransactionType {
  SALE
  RETURN
  ADJUSTMENT
}

enum UserRole {
  ADMIN
  SALESPERSON
}
